# Cursor Rules for FacebookCampaignBuilder

## Основные принципы

Cursor должен использовать информацию в `instructions/` как канонические правила.
Cursor обязан учитывать все справочники из `dictionares/`.

## Структура проекта

- **Инструкции**: `/instructions/` — канонические правила работы системы
- **Словари**: `/dictionares/` — все справочники и конфигурация
- **Примеры**: `/examples/` — шаблоны и примеры
- **Утилиты**: `/utils/` — вспомогательные функции

## Workflow создания кампании

### По умолчанию используется Facebook Marketing API

1. **Генерация нейминга** по правилам из `instructions/naming.md`
2. **Показ нейминга пользователю** с запросом подтверждения
3. **Выбор аккаунта** (если у проекта несколько `account_names`):
   - Показать список названий из `project.account_names`
   - Маппить выбранное название на `account_id` через `accounts.json`
4. **Создание через API**:
   - Campaign → получить `campaign_id`
   - Ad Set → получить `adset_id`
   - Автоматическое логирование в `logs.csv`
5. **Fallback при ошибках API**:
   - Создать CSV файл `launches/[campaign_name].csv` для ручной загрузки
   - Запись в `logs.csv` НЕ добавляется

## Работа с тирами

- **Словарь тиров**: `dictionares/tiers.json` (создается из `examples/tiers_by_countries.csv`)
- **Определение тира**:
  - Если указан тир напрямую → использовать указанный тир
  - Если указаны страны → определить тир через `tiers.json`:
    - Все страны из одного тира → использовать этот тир
    - Более 5 стран из разных тиров → использовать `WW`
    - 5 или менее стран из разных тиров → тир по большинству
- **Таргетинг на весь тир**: все страны тира из `tiers.json` добавляются в `targeting.geo_locations.countries`
- **Утилита**: использовать `utils/tier_utils.py` для определения тиров

## Работа с аккаунтами

- **Словарь аккаунтов**: `dictionares/accounts.json` — маппинг названий на ID
- **В проектах**: `projects.json` содержит `account_names` (названия, не ID)
- **При создании кампании**:
  - Если один аккаунт → использовать автоматически
  - Если несколько → показать список названий для выбора
  - Маппить название на ID через `accounts.json`

## Изменение параметров

При изменении любого параметра пользовательской командой ("измени гео", "поменяй бюджет") Cursor должен:

1. Найти параметр в соответствующей инструкции
2. Обновить его в:
   - нейминге (перегенерировать по правилам)
   - campaign settings
   - adset settings
   - targeting (если гео/возраст/гендер/язык)
   - CSV структуре (если создается fallback файл)

## Логирование

- **Автоматическое**: после успешного создания Campaign и Ad Set через API
- **Файл**: `logs.csv` с полями: `campaign_name`, `campaign_id`, `adset_id`, `created_at`
- **Утилита**: использовать `utils/logging.py` для добавления записей

## Важные правила

1. **Нейминг всегда показывается пользователю** перед созданием
2. **Файлы создаются ТОЛЬКО после подтверждения** пользователем
3. **По умолчанию используется API**, CSV создается только при ошибках
4. **Тиры определяются автоматически** через `tiers.json` если не указаны явно
5. **Аккаунты выбираются по названиям**, ID получается из `accounts.json`
6. **Все словари обязательны** — проверять наличие перед использованием

## Справочники

- `projects.json` — настройки проектов (account_names, application_id, etc.)
- `accounts.json` — маппинг названий аккаунтов на ID
- `tiers.json` — маппинг тиров на списки стран
- `objectives.json` — маппинг целей кампаний для API
- `optimization_goals.json` — маппинг моделей оптимизации
- `bid_strategies.json` — маппинг стратегий ставок
- `event_types.json` — маппинг событий на типы для API
- `events.json` — доступные события
- `languages.json` — языки для нейминга
- `locales.json` — маппинг языков на Facebook locale IDs
- `countries.json` — коды стран
- `api_config.json` — конфигурация API (access_token, api_version)

## Эталоны

- CSV структура: `/examples/sample_csv_structure.csv`
- Полный экспорт: `/examples/sample_campaign_output.csv.csv`
- Примеры запросов: `/examples/sample_campaign_request.txt`